<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana é…ç½®å‚æ•°æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ğŸŒ Nano Banana é…ç½®å‚æ•°å®Œæ•´æ€§æµ‹è¯•</h1>
        
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">æµ‹è¯•ç”¨æˆ·é…ç½®ä¼ é€’</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">API Key:</label>
                    <input type="password" id="apiKey" value="AIzaSyDN2lwEGnpNqUZUQB21y8QGuM-PHN2KG8c" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">è¾“å‡ºæ ¼å¼:</label>
                    <select id="outputFormat" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="base64">Base64</option>
                        <option value="url">URL</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">åŸºç¡€é£æ ¼:</label>
                    <select id="basePromptStyle" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">æ— </option>
                        <option value="photorealistic" selected>å†™å®æ‘„å½±</option>
                        <option value="sticker">è´´çº¸ / å›¾æ ‡</option>
                        <option value="logo">Logo / å«æ–‡å­—</option>
                        <option value="product">å•†å“å›¾ï¼ˆç™½åº•ï¼‰</option>
                        <option value="illustration">ç•™ç™½èƒŒæ™¯æ’å›¾</option>
                        <option value="comic">æ¼«ç”»åˆ†æ ¼</option>
                        <option value="flatlay">ä¿¯æ‹å¹³é“ºï¼ˆFlat-layï¼‰</option>
                        <option value="ui">UI / å›¾è§£æ’å›¾</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">ä¸»é¢˜é£æ ¼:</label>
                    <select id="styleEnhancement" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">æ— </option>
                        <option value="professional" selected>å¯ä¿¡ä¸“ä¸š</option>
                        <option value="warm">æ¸©æš–äº²å’Œ</option>
                        <option value="tech">ç§‘æŠ€æœªæ¥</option>
                        <option value="energetic">æ´»åŠ›å¹´è½»</option>
                        <option value="minimal">æç®€é«˜çº§</option>
                        <option value="natural">è‡ªç„¶æ¸…æ–°</option>
                        <option value="dramatic">æˆå‰§å¯¹æ¯”</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">æµ‹è¯•æç¤ºè¯:</label>
                <input type="text" id="altText" value="A modern coffee shop interior with comfortable seating" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md">
            </div>
            
            <button onclick="testNanoBananaConfig()" id="testBtn" 
                class="bg-yellow-600 text-white px-6 py-2 rounded-lg hover:bg-yellow-700 mb-4">
                ğŸŒ æµ‹è¯•å®Œæ•´é…ç½®ä¼ é€’
            </button>
            
            <div id="result" class="mb-4"></div>
            <div id="imageContainer"></div>
        </div>
        
        <div class="bg-gray-50 p-6 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ è°ƒè¯•æ—¥å¿—</h2>
            <pre id="debugLog" class="text-xs bg-black text-green-400 p-4 rounded-lg h-64 overflow-y-auto"></pre>
        </div>
    </div>

    <script>
        function log(message) {
            const logContainer = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.textContent += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }
        
        // åŸºç¡€é£æ ¼æ˜ å°„ï¼ˆä¸ NanoBananaService.ts ä¸­ç›¸åŒï¼‰
        const BASE_PROMPT_STYLES = {
            'photorealistic': 'photorealistic editorial photo, natural daylight, 50â€“85mm look, gentle depth of field, true-to-life color',
            'sticker': 'vector-like sticker, bold clean outlines, simple cel shading, crisp silhouette',
            'logo': 'modern minimalist logo lockup, clean bold sans-serif typography, simple geometric icon integrated with text, high legibility',
            'product': 'studio product photo on seamless white, high-key softbox lighting, subtle natural shadow under the item, ultra-sharp focus',
            'illustration': 'minimal backdrop with generous negative space for overlay text, soft diffused lighting, quiet premium mood',
            'comic': 'single comic panel, cinematic noir tone, dramatic lighting, high-contrast inks, clear focal framing',
            'flatlay': 'flat-lay composition shot from directly above, balanced arrangement, soft top light, clean background',
            'ui': 'flat, UI-inspired illustration, clear iconography, minimal color palette, high readability'
        };
        
        // ä¸»é¢˜é£æ ¼æ˜ å°„ï¼ˆä¸ NanoBananaService.ts ä¸­ç›¸åŒï¼‰
        const STYLE_ENHANCEMENTS = {
            'professional': 'neutral palette, balanced composition, soft frontal lighting, crisp detail',
            'warm': 'warm golden-hour lighting, soft shadows, welcoming mood',
            'tech': 'cool tones, subtle gradients/glass-like sheen, rim lighting, clean geometry',
            'energetic': 'high contrast, dynamic angle, energetic color accents',
            'minimal': 'minimalist layout, generous negative space, muted premium palette',
            'natural': 'natural daylight, airy atmosphere, organic textures',
            'dramatic': 'dramatic chiaroscuro lighting, deep shadows, high contrast focal point'
        };
        
        // æ¨¡æ‹Ÿ buildEnhancedPrompt å‡½æ•°
        function buildEnhancedPrompt(altText, config) {
            const enhancements = [];
            
            // é¦–å…ˆæ·»åŠ åŸå§‹æ–‡æœ¬
            enhancements.push(altText);
            
            // æ·»åŠ åŸºç¡€é£æ ¼
            if (config.basePromptStyle && BASE_PROMPT_STYLES[config.basePromptStyle]) {
                enhancements.push(BASE_PROMPT_STYLES[config.basePromptStyle]);
            }
            
            // æ·»åŠ ä¸»é¢˜é£æ ¼
            if (config.styleEnhancement && STYLE_ENHANCEMENTS[config.styleEnhancement]) {
                enhancements.push(STYLE_ENHANCEMENTS[config.styleEnhancement]);
            }
            
            return enhancements.filter(Boolean).join(', ');
        }
        
        // æµ‹è¯•å®Œæ•´çš„é…ç½®ä¼ é€’
        async function testNanoBananaConfig() {
            const testBtn = document.getElementById('testBtn');
            const result = document.getElementById('result');
            const imageContainer = document.getElementById('imageContainer');
            
            testBtn.disabled = true;
            testBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            result.innerHTML = '';
            imageContainer.innerHTML = '';
            
            try {
                log('ğŸŒ å¼€å§‹æµ‹è¯• Nano Banana å®Œæ•´é…ç½®ä¼ é€’');
                
                // æ”¶é›†ç”¨æˆ·é…ç½®
                const config = {
                    apiKey: document.getElementById('apiKey').value.trim(),
                    basePromptStyle: document.getElementById('basePromptStyle').value,
                    styleEnhancement: document.getElementById('styleEnhancement').value,
                    outputFormat: document.getElementById('outputFormat').value
                };
                
                const altText = document.getElementById('altText').value.trim();
                
                log(`ğŸ“‹ ç”¨æˆ·é…ç½®: ${JSON.stringify(config, null, 2)}`);
                log(`ğŸ“ åŸå§‹æç¤ºè¯: "${altText}"`);
                
                // æ¨¡æ‹Ÿ buildEnhancedPrompt
                const enhancedPrompt = buildEnhancedPrompt(altText, config);
                log(`âœ¨ å¢å¼ºåçš„æç¤ºè¯: "${enhancedPrompt}"`);
                
                // éªŒè¯å‚æ•°å¤„ç†
                if (!config.apiKey) {
                    throw new Error('API Key æ˜¯å¿…éœ€çš„');
                }
                
                if (!altText) {
                    throw new Error('æç¤ºè¯æ˜¯å¿…éœ€çš„');
                }
                
                log('ğŸ” å‚æ•°éªŒè¯é€šè¿‡ï¼Œå‡†å¤‡è°ƒç”¨åç«¯API');
                
                // è°ƒç”¨åç«¯API
                const response = await fetch('/api/generate/nano-banana', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: config.apiKey,
                        prompt: enhancedPrompt,
                        outputFormat: config.outputFormat
                    })
                });
                
                log(`ğŸ“¡ APIå“åº”çŠ¶æ€: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`APIè°ƒç”¨å¤±è´¥ (${response.status}): ${errorText}`);
                }
                
                const responseData = await response.json();
                log(`ğŸ“Š APIå“åº”: success=${responseData.success}, imageUrlé•¿åº¦=${responseData.imageUrl?.length || 0}`);
                
                if (responseData.success && responseData.imageUrl) {
                    result.innerHTML = '<span class="text-green-600">âœ… é…ç½®ä¼ é€’æµ‹è¯•æˆåŠŸ!</span>';
                    log('âœ… æ‰€æœ‰é…ç½®å‚æ•°æ­£ç¡®ä¼ é€’å¹¶ç”Ÿæˆå›¾ç‰‡');
                    
                    // æ˜¾ç¤ºé…ç½®è¯¦æƒ…
                    result.innerHTML += `<div class="mt-2 text-sm text-gray-600">
                        <p><strong>åŸºç¡€é£æ ¼:</strong> ${config.basePromptStyle || 'æ— '} ${config.basePromptStyle ? '(' + BASE_PROMPT_STYLES[config.basePromptStyle].substring(0,30) + '...)' : ''}</p>
                        <p><strong>ä¸»é¢˜é£æ ¼:</strong> ${config.styleEnhancement || 'æ— '} ${config.styleEnhancement ? '(' + STYLE_ENHANCEMENTS[config.styleEnhancement].substring(0,30) + '...)' : ''}</p>
                        <p><strong>è¾“å‡ºæ ¼å¼:</strong> ${responseData.format}</p>
                        <p><strong>å›¾ç‰‡ç±»å‹:</strong> ${responseData.mimeType}</p>
                    </div>`;
                    
                    // æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡
                    const img = document.createElement('img');
                    img.src = responseData.imageUrl;
                    img.className = 'max-w-full h-auto border rounded-lg shadow-lg mt-4';
                    img.alt = altText;
                    img.onload = () => log('ğŸ–¼ï¸ å›¾ç‰‡æ˜¾ç¤ºæˆåŠŸ');
                    img.onerror = () => log('âŒ å›¾ç‰‡æ˜¾ç¤ºå¤±è´¥');
                    imageContainer.appendChild(img);
                    
                } else {
                    throw new Error(responseData.error || 'æœªè¿”å›å›¾ç‰‡æ•°æ®');
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                result.innerHTML = `<span class="text-red-600">âŒ ${error.message}</span>`;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'ğŸŒ æµ‹è¯•å®Œæ•´é…ç½®ä¼ é€’';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”„ Nano Banana é…ç½®æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log(`ğŸŒ å½“å‰åŸŸå: ${window.location.origin}`);
        });
    </script>
</body>
</html>