<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯• Nano Banana å®Œæ•´æµç¨‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ğŸ” Nano Banana å®Œæ•´æµç¨‹è°ƒè¯•</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- é…ç½®æµ‹è¯• -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">1ï¸âƒ£ é…ç½®æµ‹è¯•</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Gemini API Key:</label>
                    <input type="text" id="apiKey" placeholder="AIzaSy..." 
                        class="w-full px-3 py-2 border rounded-lg text-xs">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">åŸºç¡€é£æ ¼:</label>
                    <select id="baseStyle" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">ä¸é€‰æ‹©</option>
                        <option value="photorealistic">å†™å®æ‘„å½±</option>
                        <option value="sticker">è´´çº¸é£æ ¼</option>
                        <option value="logo">Logoè®¾è®¡</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ä¸»é¢˜é£æ ¼:</label>
                    <select id="enhancement" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">ä¸é€‰æ‹©</option>
                        <option value="professional">å¯ä¿¡ä¸“ä¸š</option>
                        <option value="warm">æ¸©æš–äº²å’Œ</option>
                        <option value="tech">ç§‘æŠ€æœªæ¥</option>
                    </select>
                </div>
                
                <button onclick="testConfiguration()" id="configBtn" 
                    class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    æµ‹è¯•é…ç½®
                </button>
                
                <div id="configResult" class="mt-4 text-sm"></div>
            </div>
            
            <!-- åç«¯APIæµ‹è¯• -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">2ï¸âƒ£ åç«¯ API æµ‹è¯•</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">æç¤ºè¯:</label>
                    <textarea id="prompt" rows="3" class="w-full px-3 py-2 border rounded-lg text-xs">A cute banana wearing sunglasses, cartoon style</textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">è¾“å‡ºæ ¼å¼:</label>
                    <select id="outputFormat" class="w-full px-3 py-2 border rounded-lg">
                        <option value="base64">Base64</option>
                        <option value="url">URL</option>
                    </select>
                </div>
                
                <button onclick="testBackendAPI()" id="backendBtn" 
                    class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                    æµ‹è¯•åç«¯API
                </button>
                
                <div id="backendResult" class="mt-4 text-sm"></div>
            </div>
            
            <!-- å‰ç«¯æœåŠ¡æµ‹è¯• -->
            <div class="bg-white p-6 rounded-lg shadow md:col-span-2">
                <h2 class="text-xl font-semibold mb-4">3ï¸âƒ£ å‰ç«¯æœåŠ¡è°ƒç”¨æµ‹è¯•</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Altæ–‡æœ¬ (å‰ç«¯ä¼šä¼ é€’ç»™æœåŠ¡):</label>
                    <input type="text" id="altText" value="Professional coffee shop interior" 
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <button onclick="testFrontendService()" id="frontendBtn" 
                    class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                    æµ‹è¯•å‰ç«¯æœåŠ¡è°ƒç”¨
                </button>
                
                <div id="frontendResult" class="mt-4 text-sm"></div>
                <div id="imageContainer" class="mt-4"></div>
            </div>
            
            <!-- è°ƒè¯•æ—¥å¿— -->
            <div class="bg-gray-50 p-6 rounded-lg md:col-span-2">
                <h2 class="text-xl font-semibold mb-4">ğŸ“‹ è°ƒè¯•æ—¥å¿—</h2>
                <pre id="debugLog" class="text-xs bg-black text-green-400 p-4 rounded-lg h-64 overflow-y-auto"></pre>
                <button onclick="clearLog()" class="mt-2 bg-gray-600 text-white px-4 py-1 rounded text-sm">
                    æ¸…ç©ºæ—¥å¿—
                </button>
            </div>
        </div>
    </div>

    <script>
        let logContainer;
        
        function log(message) {
            if (!logContainer) logContainer = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.textContent += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('debugLog').textContent = '';
        }
        
        // æµ‹è¯•é…ç½®éªŒè¯
        async function testConfiguration() {
            const configBtn = document.getElementById('configBtn');
            const result = document.getElementById('configResult');
            
            configBtn.disabled = true;
            configBtn.textContent = 'æµ‹è¯•ä¸­...';
            result.textContent = '';
            
            try {
                const apiKey = document.getElementById('apiKey').value;
                const baseStyle = document.getElementById('baseStyle').value;
                const enhancement = document.getElementById('enhancement').value;
                
                log(`ğŸ”§ æµ‹è¯•é…ç½®: apiKey=${apiKey ? '***æœ‰å€¼***' : 'ç©º'}, base=${baseStyle}, enhancement=${enhancement}`);
                
                if (!apiKey.trim()) {
                    throw new Error('è¯·è¾“å…¥ API Key');
                }
                
                if (apiKey.length < 20) {
                    throw new Error('API Key é•¿åº¦ä¼¼ä¹ä¸è¶³');
                }
                
                if (!apiKey.startsWith('AIzaSy')) {
                    log('âš ï¸ è­¦å‘Š: API Key æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼ŒGemini API Key é€šå¸¸ä»¥ AIzaSy å¼€å¤´');
                }
                
                result.innerHTML = '<span class="text-green-600">âœ… é…ç½®æ ¼å¼éªŒè¯é€šè¿‡</span>';
                log('âœ… é…ç½®éªŒè¯é€šè¿‡');
                
            } catch (error) {
                result.innerHTML = `<span class="text-red-600">âŒ ${error.message}</span>`;
                log(`âŒ é…ç½®éªŒè¯å¤±è´¥: ${error.message}`);
            } finally {
                configBtn.disabled = false;
                configBtn.textContent = 'æµ‹è¯•é…ç½®';
            }
        }
        
        // æµ‹è¯•åç«¯API
        async function testBackendAPI() {
            const backendBtn = document.getElementById('backendBtn');
            const result = document.getElementById('backendResult');
            
            backendBtn.disabled = true;
            backendBtn.textContent = 'è°ƒç”¨ä¸­...';
            result.textContent = '';
            
            try {
                const apiKey = document.getElementById('apiKey').value;
                const prompt = document.getElementById('prompt').value;
                const outputFormat = document.getElementById('outputFormat').value;
                
                if (!apiKey.trim()) {
                    throw new Error('è¯·å…ˆè¾“å…¥ API Key');
                }
                
                log(`ğŸ”— è°ƒç”¨åç«¯API: /api/generate/nano-banana`);
                log(`ğŸ“¤ è¯·æ±‚å‚æ•°: prompt="${prompt.substring(0, 30)}...", format=${outputFormat}`);
                
                const requestBody = {
                    apiKey: apiKey,
                    prompt: prompt,
                    outputFormat: outputFormat
                };
                
                const response = await fetch(`${window.location.origin}/api/generate/nano-banana`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                log(`ğŸ“¡ APIå“åº”çŠ¶æ€: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`âŒ APIé”™è¯¯å“åº”: ${errorText}`);
                    throw new Error(`APIè°ƒç”¨å¤±è´¥ (${response.status}): ${errorText}`);
                }
                
                const responseData = await response.json();
                log(`ğŸ“Š APIå“åº”æ•°æ®: ${JSON.stringify(responseData).substring(0, 100)}...`);
                
                if (responseData.success) {
                    result.innerHTML = '<span class="text-green-600">âœ… åç«¯APIè°ƒç”¨æˆåŠŸï¼</span>';
                    log('âœ… åç«¯APIè°ƒç”¨æˆåŠŸ');
                    
                    if (responseData.imageUrl) {
                        log(`ğŸ–¼ï¸ æ”¶åˆ°å›¾ç‰‡URLï¼Œé•¿åº¦: ${responseData.imageUrl.length}`);
                    }
                } else {
                    throw new Error(responseData.error || 'æœªçŸ¥é”™è¯¯');
                }
                
            } catch (error) {
                result.innerHTML = `<span class="text-red-600">âŒ ${error.message}</span>`;
                log(`âŒ åç«¯APIæµ‹è¯•å¤±è´¥: ${error.message}`);
            } finally {
                backendBtn.disabled = false;
                backendBtn.textContent = 'æµ‹è¯•åç«¯API';
            }
        }
        
        // æµ‹è¯•å‰ç«¯æœåŠ¡è°ƒç”¨
        async function testFrontendService() {
            const frontendBtn = document.getElementById('frontendBtn');
            const result = document.getElementById('frontendResult');
            const imageContainer = document.getElementById('imageContainer');
            
            frontendBtn.disabled = true;
            frontendBtn.textContent = 'ç”Ÿæˆä¸­...';
            result.textContent = '';
            imageContainer.innerHTML = '';
            
            try {
                const apiKey = document.getElementById('apiKey').value;
                const altText = document.getElementById('altText').value;
                const baseStyle = document.getElementById('baseStyle').value;
                const enhancement = document.getElementById('enhancement').value;
                const outputFormat = document.getElementById('outputFormat').value;
                
                if (!apiKey.trim()) {
                    throw new Error('è¯·å…ˆè¾“å…¥ API Key');
                }
                
                log(`ğŸš€ æ¨¡æ‹Ÿå‰ç«¯æœåŠ¡è°ƒç”¨`);
                log(`ğŸ“ Altæ–‡æœ¬: "${altText}"`);
                log(`ğŸ¨ é£æ ¼é…ç½®: base=${baseStyle}, enhancement=${enhancement}`);
                
                // æ„å»ºé…ç½®å¯¹è±¡ï¼Œæ¨¡æ‹Ÿå‰ç«¯ä¼ é€’ç»™ NanoBananaService çš„å‚æ•°
                const config = {
                    apiKey: apiKey,
                    basePromptStyle: baseStyle,
                    styleEnhancement: enhancement,
                    outputFormat: outputFormat
                };
                
                log(`âš™ï¸ é…ç½®å¯¹è±¡: ${JSON.stringify(config)}`);
                
                // æ¨¡æ‹Ÿè°ƒç”¨ NanoBananaService.generateImage
                // è¿™é‡Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨åç«¯ï¼Œå› ä¸ºå‰ç«¯çš„ NanoBananaService å·²ç»ç¼–è¯‘äº†
                
                // é¦–å…ˆæµ‹è¯•é£æ ¼å¢å¼ºé€»è¾‘
                let enhancedPrompt = altText;
                if (baseStyle) {
                    const baseStyles = {
                        'photorealistic': 'photorealistic editorial photo, natural daylight, 50â€“85mm look, gentle depth of field, true-to-life color',
                        'sticker': 'vector-like sticker, bold clean outlines, simple cel shading, crisp silhouette',
                        'logo': 'modern minimalist logo lockup, clean bold sans-serif typography, simple geometric icon integrated with text, high legibility'
                    };
                    if (baseStyles[baseStyle]) {
                        enhancedPrompt += ', ' + baseStyles[baseStyle];
                    }
                }
                
                if (enhancement) {
                    const enhancements = {
                        'professional': 'neutral palette, balanced composition, soft frontal lighting, crisp detail',
                        'warm': 'warm golden-hour lighting, soft shadows, welcoming mood',
                        'tech': 'cool tones, subtle gradients/glass-like sheen, rim lighting, clean geometry'
                    };
                    if (enhancements[enhancement]) {
                        enhancedPrompt += ', ' + enhancements[enhancement];
                    }
                }
                
                log(`âœ¨ å¢å¼ºåçš„æç¤ºè¯: "${enhancedPrompt}"`);
                
                const response = await fetch(`${window.location.origin}/api/generate/nano-banana`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        prompt: enhancedPrompt,
                        outputFormat: outputFormat
                    })
                });
                
                log(`ğŸ“¡ æœ€ç»ˆAPIè°ƒç”¨çŠ¶æ€: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ç”Ÿæˆå¤±è´¥ (${response.status}): ${errorText}`);
                }
                
                const responseData = await response.json();
                
                if (responseData.success && responseData.imageUrl) {
                    result.innerHTML = '<span class="text-green-600">âœ… å‰ç«¯æœåŠ¡è°ƒç”¨æˆåŠŸï¼å›¾ç‰‡å·²ç”Ÿæˆ</span>';
                    log('âœ… å‰ç«¯æœåŠ¡è°ƒç”¨æˆåŠŸ');
                    
                    // æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡
                    const img = document.createElement('img');
                    img.src = responseData.imageUrl;
                    img.className = 'max-w-full h-auto border rounded-lg shadow-lg mt-4';
                    img.alt = altText;
                    img.onload = () => log('ğŸ–¼ï¸ å›¾ç‰‡åŠ è½½å®Œæˆ');
                    img.onerror = () => log('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥');
                    imageContainer.appendChild(img);
                    
                } else {
                    throw new Error(responseData.error || 'ç”Ÿæˆå¤±è´¥');
                }
                
            } catch (error) {
                result.innerHTML = `<span class="text-red-600">âŒ ${error.message}</span>`;
                log(`âŒ å‰ç«¯æœåŠ¡æµ‹è¯•å¤±è´¥: ${error.message}`);
            } finally {
                frontendBtn.disabled = false;
                frontendBtn.textContent = 'æµ‹è¯•å‰ç«¯æœåŠ¡è°ƒç”¨';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”„ è°ƒè¯•é¡µé¢å·²åŠ è½½');
            log(`ğŸŒ å½“å‰åŸŸå: ${window.location.origin}`);
            log('ğŸ“‹ è¯·æŒ‰é¡ºåºè¿›è¡Œæµ‹è¯•ï¼š1ï¸âƒ£é…ç½® â†’ 2ï¸âƒ£åç«¯API â†’ 3ï¸âƒ£å‰ç«¯æœåŠ¡');
        });
    </script>
</body>
</html>