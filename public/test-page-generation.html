<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡µé¢ç”Ÿæˆæµç¨‹æµ‹è¯• - Nano Banana</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ğŸ” é¡µé¢ç”Ÿæˆæµç¨‹æµ‹è¯• - Nano Banana</h1>
        
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">æ­¥éª¤1: è®¾ç½® localStorage é…ç½®</h2>
            
            <button onclick="setupNanoBananaConfig()" id="setupBtn" 
                class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 mb-4">
                ğŸ”§ è®¾ç½® Nano Banana é…ç½®åˆ° localStorage
            </button>
            
            <button onclick="checkNanoBananaConfig()" id="checkBtn" 
                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 mb-4 ml-2">
                ğŸ” æ£€æŸ¥ localStorage é…ç½®
            </button>
            
            <div id="configResult" class="mb-4"></div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">æ­¥éª¤2: æ¨¡æ‹Ÿé¡µé¢ç”Ÿæˆä¸­çš„ Nano Banana è°ƒç”¨</h2>
            
            <button onclick="testPageGeneration()" id="testPageBtn" 
                class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 mb-4">
                ğŸŒ æµ‹è¯•é¡µé¢ç”Ÿæˆä¸­çš„å›¾ç‰‡ç”Ÿæˆ
            </button>
            
            <div id="pageResult" class="mb-4"></div>
            <div id="imageContainer"></div>
        </div>
        
        <div class="bg-gray-50 p-6 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ è°ƒè¯•æ—¥å¿—</h2>
            <pre id="debugLog" class="text-xs bg-black text-green-400 p-4 rounded-lg h-64 overflow-y-auto"></pre>
        </div>
    </div>

    <script>
        function log(message) {
            const logContainer = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.textContent += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }
        
        // è®¾ç½® localStorage é…ç½®ï¼Œæ¨¡æ‹Ÿç”¨æˆ·åœ¨ä¸»é¡µé¢ä¸­çš„é…ç½®
        function setupNanoBananaConfig() {
            log('ğŸ”§ å¼€å§‹è®¾ç½® Nano Banana é…ç½®åˆ° localStorage');
            
            const config = {
                apiKey: 'AIzaSyDN2lwEGnpNqUZUQB21y8QGuM-PHN2KG8c',
                basePromptStyle: 'photorealistic',
                styleEnhancement: 'professional',
                outputFormat: 'base64'
            };
            
            localStorage.setItem('nanoBananaConfig', JSON.stringify(config));
            log(`âœ… å·²ä¿å­˜ Nano Banana é…ç½®: ${JSON.stringify(config, null, 2)}`);
            
            document.getElementById('configResult').innerHTML = 
                '<span class="text-green-600">âœ… Nano Banana é…ç½®å·²ä¿å­˜åˆ° localStorage</span>';
        }
        
        // æ£€æŸ¥ localStorage é…ç½®
        function checkNanoBananaConfig() {
            log('ğŸ” æ£€æŸ¥ localStorage ä¸­çš„ Nano Banana é…ç½®');
            
            const configStr = localStorage.getItem('nanoBananaConfig');
            if (configStr) {
                const config = JSON.parse(configStr);
                log(`âœ… æ‰¾åˆ°é…ç½®: ${JSON.stringify(config, null, 2)}`);
                
                document.getElementById('configResult').innerHTML = 
                    `<span class="text-green-600">âœ… æ‰¾åˆ°é…ç½®</span><br><pre class="text-xs mt-2 bg-gray-100 p-2 rounded">${JSON.stringify(config, null, 2)}</pre>`;
            } else {
                log('âŒ æœªæ‰¾åˆ° nanoBananaConfig');
                document.getElementById('configResult').innerHTML = 
                    '<span class="text-red-600">âŒ æœªæ‰¾åˆ° nanoBananaConfig åœ¨ localStorage ä¸­</span>';
            }
        }
        
        // æ¨¡æ‹Ÿä¸»é¡µé¢ç”Ÿæˆæµç¨‹ä¸­çš„å›¾ç‰‡ç”Ÿæˆ
        async function testPageGeneration() {
            const testBtn = document.getElementById('testPageBtn');
            const result = document.getElementById('pageResult');
            const imageContainer = document.getElementById('imageContainer');
            
            testBtn.disabled = true;
            testBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            result.innerHTML = '';
            imageContainer.innerHTML = '';
            
            try {
                log('ğŸŒ å¼€å§‹æ¨¡æ‹Ÿé¡µé¢ç”Ÿæˆæµç¨‹ä¸­çš„ Nano Banana å›¾ç‰‡ç”Ÿæˆ');
                
                // æ­¥éª¤1: æ¨¡æ‹Ÿä¸»é¡µé¢ä¸­çš„é…ç½®åŠ è½½é€»è¾‘ (src/index.tsx:1326-1342)
                log('ğŸ“‹ æ­¥éª¤1: åŠ è½½é…ç½® (æ¨¡æ‹Ÿ src/index.tsx:1326-1342)');
                
                // æ¨¡æ‹Ÿ imageProvider é€‰æ‹© 
                const imageProvider = 'nano-banana';
                log(`ğŸ”§ å›¾ç‰‡æä¾›å•†: ${imageProvider}`);
                
                // æ¨¡æ‹Ÿé…ç½®å¯¹è±¡åˆå§‹åŒ–
                let modelConfig = {
                    provider: imageProvider,
                    model: 'gemini-2.5-flash-image-preview',
                    imageApiKey: null,
                    nanoBanana: null
                };
                
                // ğŸ”§ æ¨¡æ‹Ÿä¸»é¡µé¢çš„ Nano Banana é…ç½®åŠ è½½é€»è¾‘ (ç¬¬1326-1342è¡Œ)
                if (imageProvider === 'nano-banana') {
                    try {
                        const nanoBananaConfigStr = localStorage.getItem('nanoBananaConfig');
                        if (nanoBananaConfigStr) {
                            modelConfig.nanoBanana = JSON.parse(nanoBananaConfigStr);
                            // ğŸ”§ å…³é”®ä¿®å¤ï¼šç¡®ä¿ API Key æ­£ç¡®ä¼ é€’åˆ° imageApiKey
                            if (modelConfig.nanoBanana.apiKey && !modelConfig.imageApiKey) {
                                modelConfig.imageApiKey = modelConfig.nanoBanana.apiKey;
                            }
                            log('âœ… [Config] å·²åŠ è½½ Nano Banana é…ç½®: ' + JSON.stringify(modelConfig.nanoBanana));
                        } else {
                            log('âš ï¸ [Config] localStorage ä¸­æœªæ‰¾åˆ° Nano Banana é…ç½®');
                        }
                    } catch (error) {
                        log('âŒ [Config] åŠ è½½ Nano Banana é…ç½®å¤±è´¥: ' + error.message);
                    }
                }
                
                log(`ğŸ” æœ€ç»ˆé…ç½®å¯¹è±¡: ${JSON.stringify(modelConfig, null, 2)}`);
                
                // æ­¥éª¤2: æ¨¡æ‹Ÿ generateImageWithNanoBanana è°ƒç”¨ (src/index.tsx:5762-5830)
                log('ğŸ“‹ æ­¥éª¤2: è°ƒç”¨ generateImageWithNanoBanana');
                
                const altText = 'A professional coffee shop with modern design';
                log(`ğŸ“ Altæ–‡æœ¬: ${altText}`);
                
                const imageUrl = await generateImageWithNanoBanana(altText, modelConfig);
                
                log('âœ… å›¾ç‰‡ç”ŸæˆæˆåŠŸ!');
                result.innerHTML = '<span class="text-green-600">âœ… é¡µé¢ç”Ÿæˆæµç¨‹æµ‹è¯•æˆåŠŸï¼</span>';
                
                // æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡
                const img = document.createElement('img');
                img.src = imageUrl;
                img.className = 'max-w-full h-auto border rounded-lg shadow-lg mt-4';
                img.alt = altText;
                img.onload = () => log('ğŸ–¼ï¸ å›¾ç‰‡æ˜¾ç¤ºæˆåŠŸ');
                img.onerror = () => log('âŒ å›¾ç‰‡æ˜¾ç¤ºå¤±è´¥');
                imageContainer.appendChild(img);
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                log(`âŒ é”™è¯¯å †æ ˆ: ${error.stack}`);
                result.innerHTML = `<span class="text-red-600">âŒ ${error.message}</span>`;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'ğŸŒ æµ‹è¯•é¡µé¢ç”Ÿæˆä¸­çš„å›¾ç‰‡ç”Ÿæˆ';
            }
        }
        
        // ğŸ”§ æ¨¡æ‹Ÿ generateImageWithNanoBanana å‡½æ•° (src/index.tsx:5762-5830)
        async function generateImageWithNanoBanana(altText, imageConfig) {
            log('ğŸŒ [Nano Banana] å¼€å§‹å›¾ç‰‡ç”Ÿæˆ: ' + altText.substring(0, 50));
            log('ğŸ” [Nano Banana] ç¯å¢ƒä¿¡æ¯: ' + JSON.stringify({
                userAgent: navigator.userAgent.substring(0, 50),
                origin: window.location.origin,
                timestamp: new Date().toISOString()
            }));
            
            // ä½¿ç”¨ç»Ÿä¸€é…ç½®ä¸­çš„ nanoBanana é…ç½®
            let nanoBananaConfig;
            
            // ğŸ”§ ä¿®å¤ï¼šæ”¹è¿›é…ç½®è·å–é€»è¾‘ï¼Œæ”¯æŒå¤šç§é…ç½®ç»“æ„ (src/index.tsx:5773-5804)
            log('ğŸ” [Nano Banana] è°ƒè¯• imageConfig ç»“æ„: ' + JSON.stringify({
                hasNanoBanana: !!imageConfig.nanoBanana,
                hasApiKey: !!imageConfig.apiKey,
                hasProvider: imageConfig.provider,
                configKeys: Object.keys(imageConfig),
                fullConfig: imageConfig
            }));
            
            if (imageConfig.nanoBanana) {
                // ä½¿ç”¨ç»Ÿä¸€é…ç½®ä¸­çš„å®Œæ•´é…ç½®
                nanoBananaConfig = {
                    apiKey: imageConfig.nanoBanana.apiKey || imageConfig.apiKey,
                    basePromptStyle: imageConfig.nanoBanana.basePromptStyle || '',
                    styleEnhancement: imageConfig.nanoBanana.styleEnhancement || '',
                    outputFormat: imageConfig.outputFormat || imageConfig.nanoBanana.outputFormat || 'base64'
                };
            } else {
                // é™çº§åˆ°åŸºæœ¬é…ç½®ï¼ˆä½¿ç”¨ apiKeyï¼‰
                const apiKey = imageConfig.apiKey || imageConfig.key || imageConfig.token;
                if (!apiKey) {
                    log('âŒ [Nano Banana] imageConfig ä¸­æœªæ‰¾åˆ° API key: ' + JSON.stringify(imageConfig));
                    throw new Error('Nano Banana requires API key. Please configure it in the modal or check your configuration.');
                }
                nanoBananaConfig = {
                    apiKey: apiKey,
                    basePromptStyle: '',
                    styleEnhancement: '',
                    outputFormat: imageConfig.outputFormat || 'base64'
                };
            }
            
            log('ğŸ” [Nano Banana] æœ€ç»ˆé…ç½®: ' + JSON.stringify({
                hasApiKey: !!nanoBananaConfig.apiKey,
                apiKeyLength: nanoBananaConfig.apiKey?.length || 0,
                basePromptStyle: nanoBananaConfig.basePromptStyle,
                styleEnhancement: nanoBananaConfig.styleEnhancement,
                outputFormat: nanoBananaConfig.outputFormat
            }));
            
            // æ„å»ºå¢å¼ºæç¤ºè¯
            const enhancements = [];
            enhancements.push(altText);
            
            const BASE_PROMPT_STYLES = {
                'photorealistic': 'photorealistic editorial photo, natural daylight, 50â€“85mm look, gentle depth of field, true-to-life color'
            };
            const STYLE_ENHANCEMENTS = {
                'professional': 'neutral palette, balanced composition, soft frontal lighting, crisp detail'
            };
            
            if (nanoBananaConfig.basePromptStyle && BASE_PROMPT_STYLES[nanoBananaConfig.basePromptStyle]) {
                enhancements.push(BASE_PROMPT_STYLES[nanoBananaConfig.basePromptStyle]);
            }
            
            if (nanoBananaConfig.styleEnhancement && STYLE_ENHANCEMENTS[nanoBananaConfig.styleEnhancement]) {
                enhancements.push(STYLE_ENHANCEMENTS[nanoBananaConfig.styleEnhancement]);
            }
            
            const enhancedPrompt = enhancements.filter(Boolean).join(', ');
            log('âœ¨ å¢å¼ºåçš„æç¤ºè¯: "' + enhancedPrompt + '"');
            
            // è°ƒç”¨åç«¯API
            log('ğŸš€ [Nano Banana] è°ƒç”¨ NanoBananaService.generateImage...');
            
            const response = await fetch('/api/generate/nano-banana', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    apiKey: nanoBananaConfig.apiKey,
                    prompt: enhancedPrompt,
                    outputFormat: nanoBananaConfig.outputFormat || 'base64'
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                log(`âŒ API å“åº”é”™è¯¯ (${response.status}): ${errorText}`);
                throw new Error(`Image generation failed: ${response.status} - ${errorText}`);
            }
            
            const result = await response.json();
            log('ğŸ“Š API å“åº”: ' + JSON.stringify({
                success: result.success,
                hasImageUrl: !!result.imageUrl,
                imageUrlLength: result.imageUrl?.length || 0,
                error: result.error
            }));
            
            if (!result.success || !result.imageUrl) {
                throw new Error(result.error || 'No image data received');
            }
            
            log('âœ… [Nano Banana] æˆåŠŸé€šè¿‡åç«¯ä»£ç†ç”Ÿæˆå›¾ç‰‡');
            return result.imageUrl;
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”„ é¡µé¢ç”Ÿæˆæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log(`ğŸŒ å½“å‰åŸŸå: ${window.location.origin}`);
            log('ğŸ’¡ è¯·å…ˆç‚¹å‡»"è®¾ç½® Nano Banana é…ç½®"ï¼Œç„¶åç‚¹å‡»"æµ‹è¯•é¡µé¢ç”Ÿæˆ"');
        });
    </script>
</body>
</html>