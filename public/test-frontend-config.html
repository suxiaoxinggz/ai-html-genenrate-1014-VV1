<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯é…ç½®ä¼ é€’æµ‹è¯• - Nano Banana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">
            ğŸ” å‰ç«¯é…ç½®ä¼ é€’æµ‹è¯• - Nano Banana
        </h1>
        
        <!-- æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥çš„é…ç½® -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ›ï¸ ç”¨æˆ·è¾“å…¥é…ç½®</h2>
            
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                    <input type="text" id="userApiKey" class="w-full border rounded px-3 py-2" 
                           value="AIzaSyDN2lwEGnpNqUZUQB21y8QGuM-PHN2KG8c"
                           placeholder="è¾“å…¥ä½ çš„ Google API Key">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">è¾“å‡ºæ ¼å¼</label>
                    <select id="outputFormat" class="w-full border rounded px-3 py-2">
                        <option value="base64">Base64</option>
                        <option value="url">URL</option>
                    </select>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Base Prompt Style</label>
                    <input type="text" id="basePromptStyle" class="w-full border rounded px-3 py-2"
                           placeholder="ä¾‹å¦‚: professional, artistic, modern"
                           value="professional photography style">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Style Enhancement</label>
                    <input type="text" id="styleEnhancement" class="w-full border rounded px-3 py-2"
                           placeholder="ä¾‹å¦‚: high quality, detailed, 4K"
                           value="high quality, detailed, professional lighting">
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">æµ‹è¯•æç¤ºè¯</label>
                <input type="text" id="testPrompt" class="w-full border rounded px-3 py-2"
                       value="Modern office building with glass facade and professional architecture"
                       placeholder="è¾“å…¥å›¾ç‰‡ç”Ÿæˆæç¤ºè¯">
            </div>
            
            <button onclick="testConfigPassing()" 
                    id="testBtn"
                    class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700">
                ğŸ§ª æµ‹è¯•é…ç½®ä¼ é€’å’Œå›¾ç‰‡ç”Ÿæˆ
            </button>
        </div>

        <!-- ç»“æœæ˜¾ç¤º -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            <div id="results" class="space-y-4">
                <p class="text-gray-600">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>
            </div>
        </div>
    </div>

    <script>
        async function testConfigPassing() {
            const testBtn = document.getElementById('testBtn');
            const results = document.getElementById('results');
            
            testBtn.disabled = true;
            testBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            
            // æ¸…ç©ºç»“æœ
            results.innerHTML = '<p class="text-blue-600">ğŸ”„ æ­£åœ¨æµ‹è¯•é…ç½®ä¼ é€’...</p>';
            
            try {
                // 1. æ¨¡æ‹Ÿç”¨æˆ·åœ¨å‰ç«¯é…ç½® Nano Banana
                const userConfig = {
                    apiKey: document.getElementById('userApiKey').value,
                    basePromptStyle: document.getElementById('basePromptStyle').value,
                    styleEnhancement: document.getElementById('styleEnhancement').value,
                    outputFormat: document.getElementById('outputFormat').value
                };
                
                const testPrompt = document.getElementById('testPrompt').value;
                
                // 2. ä¿å­˜é…ç½®åˆ° localStorage (æ¨¡æ‹Ÿå‰ç«¯é…ç½®ä¿å­˜)
                localStorage.setItem('imageApiKey', userConfig.apiKey);
                localStorage.setItem('nanoBananaConfig', JSON.stringify({
                    apiKey: userConfig.apiKey,
                    basePromptStyle: userConfig.basePromptStyle,
                    styleEnhancement: userConfig.styleEnhancement,
                    outputFormat: userConfig.outputFormat
                }));
                
                results.innerHTML = `
                    <div class="space-y-2">
                        <p class="text-green-600">âœ… æ­¥éª¤1: ç”¨æˆ·é…ç½®å·²ä¿å­˜åˆ° localStorage</p>
                        <div class="bg-gray-50 p-3 rounded text-sm">
                            <pre>${JSON.stringify(userConfig, null, 2)}</pre>
                        </div>
                        <p class="text-blue-600">ğŸ”„ æ­¥éª¤2: æ¨¡æ‹Ÿå‰ç«¯ collectUnifiedConfig() æ”¶é›†é…ç½®...</p>
                    </div>
                `;
                
                // 3. æ¨¡æ‹Ÿ collectUnifiedConfig() å‡½æ•°
                const unifiedConfig = collectUnifiedConfigTest();
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                results.innerHTML += `
                    <div class="space-y-2">
                        <p class="text-green-600">âœ… æ­¥éª¤2: ç»Ÿä¸€é…ç½®æ”¶é›†å®Œæˆ</p>
                        <div class="bg-gray-50 p-3 rounded text-sm">
                            <strong>Image Config:</strong>
                            <pre>${JSON.stringify(unifiedConfig.image, null, 2)}</pre>
                        </div>
                        <p class="text-blue-600">ğŸ”„ æ­¥éª¤3: å‘é€åˆ°åç«¯è¿›è¡Œå›¾ç‰‡ç”Ÿæˆ...</p>
                    </div>
                `;
                
                // 4. å‘é€è¯·æ±‚åˆ°åç«¯
                const requestStartTime = Date.now();
                
                const response = await axios.post('/api/generate/nano-banana', {
                    prompt: testPrompt,
                    apiKey: userConfig.apiKey,
                    basePromptStyle: userConfig.basePromptStyle,
                    styleEnhancement: userConfig.styleEnhancement,
                    outputFormat: userConfig.outputFormat
                });
                
                const requestDuration = Date.now() - requestStartTime;
                
                if (response.data.success) {
                    const imageSize = response.data.imageUrl ? response.data.imageUrl.length : 0;
                    
                    results.innerHTML += `
                        <div class="space-y-2">
                            <p class="text-green-600">âœ… æ­¥éª¤3: åç«¯å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼</p>
                            <div class="bg-green-50 p-3 rounded">
                                <p><strong>å“åº”æ—¶é—´:</strong> ${requestDuration}ms</p>
                                <p><strong>å›¾ç‰‡å¤§å°:</strong> ${imageSize} characters</p>
                                <p><strong>è¾“å‡ºæ ¼å¼:</strong> ${userConfig.outputFormat}</p>
                            </div>
                            
                            ${response.data.imageUrl ? `
                            <div class="mt-4">
                                <h4 class="font-semibold mb-2">ğŸ–¼ï¸ ç”Ÿæˆçš„å›¾ç‰‡:</h4>
                                <img src="${response.data.imageUrl}" 
                                     alt="Generated image" 
                                     class="max-w-full h-64 object-contain rounded border">
                            </div>
                            ` : ''}
                            
                            <div class="bg-blue-50 p-4 rounded mt-4">
                                <h4 class="font-semibold text-blue-800 mb-2">ğŸ¯ ç»“è®º:</h4>
                                <p class="text-blue-700">
                                    âœ… <strong>ç”¨æˆ·å‰ç«¯è¾“å…¥çš„ API KEY å’Œå‚æ•°èƒ½å¤Ÿæ­£ç¡®ä¼ é€’åˆ° Nano Banana æ¨¡å‹ï¼</strong>
                                </p>
                                <ul class="list-disc list-inside mt-2 text-blue-600 text-sm">
                                    <li>API Key æ­£ç¡®ä¼ é€’å’ŒéªŒè¯</li>
                                    <li>basePromptStyle å‚æ•°ç”Ÿæ•ˆ</li>
                                    <li>styleEnhancement å‚æ•°ç”Ÿæ•ˆ</li>
                                    <li>outputFormat é€‰æ‹©ç”Ÿæ•ˆ</li>
                                    <li>å›¾ç‰‡ç”ŸæˆæˆåŠŸå®Œæˆ</li>
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(response.data.error || 'ç”Ÿæˆå¤±è´¥');
                }
                
            } catch (error) {
                results.innerHTML += `
                    <div class="bg-red-50 p-4 rounded">
                        <p class="text-red-600">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</p>
                        <p class="text-red-500 text-sm mt-2">è¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œè¿æ¥</p>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'ğŸ§ª é‡æ–°æµ‹è¯•é…ç½®ä¼ é€’';
            }
        }
        
        // æ¨¡æ‹Ÿå‰ç«¯çš„ collectUnifiedConfig å‡½æ•°
        function collectUnifiedConfigTest() {
            const safeGet = (k) => {
                try { 
                    return sessionStorage.getItem(k) || localStorage.getItem(k); 
                } catch { 
                    return null; 
                }
            };
            
            const json = (k, defaultValue) => { 
                try { 
                    const val = safeGet(k);
                    return val ? JSON.parse(val) : defaultValue; 
                } catch { 
                    return defaultValue; 
                } 
            };

            return {
                image: {
                    provider: 'nano-banana',
                    apiKey: safeGet('imageApiKey') || '',
                    outputFormat: document.getElementById('outputFormat').value || 'base64',
                    nanoBanana: json('nanoBananaConfig', { 
                        basePromptStyle: '', 
                        styleEnhancement: '' 
                    })
                }
            };
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ Nano Banana é…ç½®ä¼ é€’æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>