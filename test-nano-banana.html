<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana API Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold mb-6">Nano Banana API 测试</h1>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">API Key:</label>
                <input type="text" id="apiKey" value="AIzaSyDxGgnSybVtEKAO9JwluuEA5laIIcUsHMM" 
                       class="w-full p-2 border rounded">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">图片描述:</label>
                <textarea id="prompt" class="w-full p-2 border rounded" rows="3">A modern coffee shop interior with warm lighting, comfortable seating, and a professional coffee bar setup</textarea>
            </div>
            
            <button onclick="testNanoBanana()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                测试 Nano Banana 生成
            </button>
        </div>
        
        <div id="result" class="mt-6"></div>
        <div id="error" class="mt-6 text-red-600"></div>
        <div id="logs" class="mt-6 bg-gray-100 p-4 rounded text-sm"></div>
    </div>

    <script>
        function log(message) {
            const logs = document.getElementById('logs');
            logs.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
        }

        async function testNanoBanana() {
            const apiKey = document.getElementById('apiKey').value;
            const prompt = document.getElementById('prompt').value;
            const errorDiv = document.getElementById('error');
            const resultDiv = document.getElementById('result');
            
            errorDiv.innerHTML = '';
            resultDiv.innerHTML = '';
            document.getElementById('logs').innerHTML = '';
            
            log('开始测试 Nano Banana API...');
            
            try {
                const requestBody = {
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                };
                
                log('发送请求到 Gemini API...');
                log('Prompt: ' + prompt);
                
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent', {
                    method: 'POST',
                    headers: {
                        'x-goog-api-key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                log('收到响应，状态码: ' + response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log('错误响应: ' + errorText);
                    throw new Error(`API调用失败: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                log('解析响应数据...');
                log('响应结构: ' + JSON.stringify(Object.keys(data)));
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                    log('找到候选结果，检查parts...');
                    
                    for (let i = 0; i < data.candidates[0].content.parts.length; i++) {
                        const part = data.candidates[0].content.parts[i];
                        log(`Part ${i}: ${JSON.stringify(Object.keys(part))}`);
                        
                        if (part.inlineData && part.inlineData.data) {
                            log('找到图片数据！');
                            const mimeType = part.inlineData.mimeType || 'image/png';
                            const base64Data = part.inlineData.data;
                            
                            const dataUrl = `data:${mimeType};base64,${base64Data}`;
                            
                            resultDiv.innerHTML = `
                                <h3 class="text-lg font-bold mb-2">生成成功!</h3>
                                <img src="${dataUrl}" class="max-w-full rounded shadow" alt="Generated image">
                                <p class="text-sm text-gray-600 mt-2">MIME Type: ${mimeType}</p>
                                <p class="text-sm text-gray-600">Base64 Length: ${base64Data.length}</p>
                            `;
                            
                            log('图片显示成功！');
                            return;
                        }
                    }
                    
                    log('没有找到图片数据在parts中');
                    log('完整响应: ' + JSON.stringify(data, null, 2));
                } else {
                    log('响应格式不正确');
                    log('完整响应: ' + JSON.stringify(data, null, 2));
                }
                
                throw new Error('没有找到图片数据');
                
            } catch (error) {
                log('发生错误: ' + error.message);
                errorDiv.innerHTML = '错误: ' + error.message;
            }
        }
    </script>
</body>
</html>